#!/usr/bin/env bash
# bin/compile <BUILD_DIR> <CACHE_DIR> <ENV_DIR>

set -eu -o pipefail

BUILDPACK_DIR="$(dirname "$(dirname "$0")")"
BUILD_DIR="$1"
CACHE_DIR="$2"

VENDOR_DIR="/app/.heroku/vendor"

echo '-----> Adding BUNDLE_BUILD__RGEO variable to environment'

# write profile script
mkdir -p $BUILD_DIR/.profile.d
cat <<EOF >$BUILD_DIR/.profile.d/000_rgeo_prep.sh
export BUNDLE_BUILD__RGEO="--with-opt-dir=$VENDOR_DIR --with-geos-config=$VENDOR_DIR/bin/geos-config"
EOF

# export to other buildpacks
export BUNDLE_BUILD__RGEO="--with-opt-dir=$VENDOR_DIR --with-geos-config=$VENDOR_DIR/bin/geos-config"
export | grep -E -e ' (BUNDLE_BUILD__RGEO)=' >"$BUILDPACK_DIR/export"

echo `cat $BUILD_DIR/.profile.d/000_rgeo_prep.sh`
echo `which geos-config`
echo `ls /app/.heroku/vendor`
